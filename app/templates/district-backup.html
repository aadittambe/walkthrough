<!doctype html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://use.typekit.net/kdc4trt.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../static/districts.css" />
    <link rel="stylesheet" href="../../static/search-inside.css">
    <link rel="stylesheet" href="https://use.typekit.net/ipw6blv.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
</head>

<body>
    <div class="search-block">
        <div class="app-search">
            <div class="search-row">
                <input id="fill-box" type="text" placeholder="Search school or district ...">
                <i class="fa fa-search"></i>
            </div>
        </div>
        <div id="suggestions-list" class="list-items"></div>
    </div>
    <div id="container">
        <div id="title">
            <h1>{{ district.district }}</h1>
            <h2>{{ district.total_actively_enrolled_students }} students</h2>
         
        </div>

        <div class="row">
            <div class="col">
                <div id='map' class="map-border"></div>
            </div>
            <div class="col">
                <div class="school-col-inner">
                    <h4>Find a school in this district</h2>
                    <div class="inner-text">
                        <ul>
                            {% for school in school_object_list %}
                            {% if school.district_alt == district.district_alt %}
                            {% if school.year == "2021" %}
                            <li><a href="../../school/{{ school.school_id }}/">{{ school.school }}</a></li>
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div> <!-- ends row -->

        <div id="viz-row-1">
            <div class="row">
                <div class="col-sm">
                    <div class="chart-border">
                        <h5>Students by race</h5>
                        <div id="chart-1"></div>
                    </div>
                </div>
                <div class="col-sm">
                    <div class="chart-border">
                        <h5>Students by gender</h5>
                        <div id="chart-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="viz-row-2">
            <div class="row">
                <div class="col-sm">
                    <div class="chart-border">
                        <h5>Students in poverty</h5>
                        <div id="chart-3"></div>
                    </div>
                </div>
            </div>
        </div>



    <div id="viz-row-3">
        <div class="row">
            <div class="col-sm">
                <div class="chart-border">
                    <h5>Students gender 2</h5>
                    <div id="chart-4"></div>
                </div>
        </div>
    </div>

    <div id="viz-row-4">
            <div class="row">
                <div class="col-sm">
                    <div class="chart-border">
                        <!-- <h5>Students sdf race</h5> -->
                        <div id="chart-5"></div>
                    </div>
                </div>
                <div class="col-sm">
                    <div class="chart-border">
                        <!-- <h5>Students xxdf gender</h5>-->
                        <div id="chart-6"></div>
                    </div>
                </div>
            </div>
        </div>


    </div> <!-- ends container -->

    <!-- load d3 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>


    <-- fuse js -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.1"></script>

    
    <!-- javascript -->
    <script>

        // // //
        // LEAFLET MAP
        // // //

        var map = L.map('map', {
        }).setView([33.4, -81.1], 7);

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYWFkaXR0YW1iZSIsImEiOiJja3R2eDFjZjMyZXJxMnhwcTR0Y3F5eGk2In0.9AAyIXkTkCMcZ8NNlDPB9g', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/light-v9',
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);

        {% for school in school_object_list %}
        {% if school.district_alt == district.district_alt %}
        {% if school.year == "2021" %}
        {% if school.lat != "no_result" %}
         var marker = L.marker([ {{school.lat}}, {{school.lon}} ]).addTo(map)
                .bindPopup('<b><a href="../../school/{{ school.school_id }}">{{ school.school }}</a></b>');
        {% endif %}
        {% endif %}
        {% endif %}
        {% endfor %}


        // // //
        // BAR CHART 2
        // // // 

        var genderChartWidth = document.getElementById('chart-2').clientWidth;
        function groupGenderData(data, total) {
                    const percent = d3.scaleLinear()
                        .domain([0, total])
                        .range([0, 100])
                    let cumulative = 0
                    const _data = data.map(d => {
                        cumulative += d.value
                        return {
                            value: d.value,
                            cumulative: cumulative - d.value,
                            label: d.label,
                            percent: percent(d.value)
                        }
                    }).filter(d => d.value > 0)
                    return _data
                }


        const genderData = [
            { label: 'Male', value: {{ district.percent_male }} },
            { label: 'Female', value: {{ district.percent_female }} },
            { label: 'Gender unknown', value: {{ district.percent_gender_missing }} },
                ]

        function genderBar(bind, data, config) {
                    config = {
                        f: d3.format('.1f'),
                        margin: { top: 0, right: 0, bottom: 0, left: 0 },
                        width: genderChartWidth,
                        height: 200,
                        barHeight: 100,
                        colors: ['#F2734F', '#9264BA', '#82C566', '#984ea3','#F0DD67', '#1CAECC', '#ffff33'],
                        ...config
                    }
                    const { f, margin, width, height, barHeight, colors } = config
                    const w = width - margin.left - margin.right
                    const h = height - margin.top - margin.bottom
                    const halfBarHeight = barHeight / 2

                    const total = d3.sum(data, d => d.value)
                    const _data = groupGenderData(data, total)

                    const xScale = d3.scaleLinear()
                        .domain([0, total])
                        .range([0, w])

                    const selection = d3.select(bind)
                        .append('svg')
                        .attr('width', width)
                        .attr('height', height)
                        .append('g')
                        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')

                    selection.selectAll('rect')
                        .data(_data)
                        .enter().append('rect')
                        .attr('class', 'rect-stacked')
                        .attr('x', d => xScale(d.cumulative))
                        .attr('y', h / 2 - halfBarHeight)
                        .attr('height', barHeight)
                        .attr('width', d => xScale(d.value))
                        .style('fill', (d, i) => colors[i])

                    selection.selectAll('.text-percent')
                        .data(_data)
                        .enter().append('text')
                        .attr('class', 'text-percent')
                        .attr('text-anchor', 'middle')
                        .attr('x', d => xScale(d.cumulative) + (xScale(d.value) / 2))
                        .attr('y', (h / 2) - (halfBarHeight * 1.1))
                        .text(d => f(d.percent) + ' %')

                    selection.selectAll('.text-label')
                        .data(_data)
                        .enter().append('text')
                        .attr('class', 'text-label')
                        .attr('text-anchor', 'middle')
                        .attr('x', d => xScale(d.cumulative) + (xScale(d.value) / 2))
                        .attr('y', (h / 2) + (halfBarHeight * 1.1) + 20)
                        .style('fill', (d, i) => colors[i])
                        .text(d => d.label)
                }
                genderBar('#chart-2', genderData)



        // // //
        // SEARCH SCRIPT
        // // //

        const searchInput = document.querySelector('#fill-box')

        searchInput.addEventListener("input", (e) => {
            let value = e.target.value
            if (value && value.trim().length > 2) {
                d3.csv("../../static/etl_schools_all_years_with_coords.csv").then(function (data) {
                    const fuse = new Fuse(data, {
                        keys: ['school_x','district_x'],
                        minMatchCharLength: 3,
                        distance: 50,
                        includeMatches: true,
                        threshold: 0.1
                    })
                var results = fuse.search(value)
                console.log(results.length)
                if(results.length>1){
                    
                    d3.select(".search-eg")
                        .style("display","none")
                    d3.select("#suggestions-list")
                        .style("display","block")
                }

                let div = d3.select("#suggestions-list")
                    .html("")
                    .selectAll('.result')
                    .data(results)
                    .enter().append('div')

                let img = div
                    .append('img')
                    .attr("src",function(d){
                        if (d.matches[0].key == "school_x"){
                            return "../../static/school.png"
                        } else if (d.matches[0].key == "district_x"){
                            return "../../static/district.png"
                        }
                    })

                let text = div
                    .append('p')
                    .append('a')
                    .attr('href',function(d){
                        if (d.matches[0].key == "school_x"){
                            return `school/${d.item.school_id}`
                        } else{
                            //console.log("something happened")
                        }
                    })
                    .text(function (d) {
                        //console.log(d.matches[0].key)
                        if (d.matches[0].key == "school_x"){
                            return `${d.item.school_x}`
                        } else if (d.matches[0].key == "district_x"){
                            return `${d.item.district_x}`
                        }
                    })
                    
                })
            } else {
                d3.select(".search-eg")
                        .style("display","flex")
                d3.select("#suggestions-list")
                    .style("display","none")
            }

        })







        // // //
        // BAR CHART 1
        // // // 


        var raceChartWidth = document.getElementById('chart-1').clientWidth;
         function groupRaceData(data, total) {
                const percent = d3.scaleLinear()
                    .domain([0, total])
                    .range([0, 100])
                let cumulative = 0
                const _data = data.map(d => {
                    cumulative += d.value
                    return {
                        value: d.value,
                        cumulative: cumulative - d.value,
                        label: d.label,
                        percent: percent(d.value)
                    }
                }).filter(d => d.value > 0)
                return _data
            }
            const raceData = [
                { label: 'White', value:  {{district.percent_white}} },
                { label: 'Other', value:  {{district.percent_all_other_races}} },
                { label: 'Black', value: {{district.percent_black_aa}} },
            ]

            function raceBar(bind, data, config) {
                config = {
                    f: d3.format('.1f'),
                    margin: { top: 0, right: 0, bottom: 0, left: 0 },
                    width: raceChartWidth,
                    height: 200,
                    barHeight: 100,
                    colors: ['#F2734F', '#9264BA', '#82C566', '#984ea3','#F0DD67', '#1CAECC', '#ffff33'],
                    ...config
                }
                const { f, margin, width, height, barHeight, colors } = config
                const w = width - margin.left - margin.right
                const h = height - margin.top - margin.bottom
                const halfBarHeight = barHeight / 2

                const total = d3.sum(data, d => d.value)
                const _data = groupRaceData(data, total)

                const xScale = d3.scaleLinear()
                    .domain([0, total])
                    .range([0, w])

                const selection = d3.select(bind)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .append('g')
                    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')

                selection.selectAll('rect')
                    .data(_data)
                    .enter().append('rect')
                    .attr('class', 'rect-stacked')
                    .attr('x', d => xScale(d.cumulative))
                    .attr('y', h / 2 - halfBarHeight)
                    .attr('height', barHeight)
                    .attr('width', d => xScale(d.value))
                    .style('fill', (d, i) => colors[i])

                selection.selectAll('.text-percent')
                    .data(_data)
                    .enter().append('text')
                    .attr('class', 'text-percent')
                    .attr('text-anchor', 'middle')
                    .attr('x', d => xScale(d.cumulative) + (xScale(d.value) / 2))
                    .attr('y', (h / 2) - (halfBarHeight * 1.1))
                    .text(d => f(d.percent) + ' %')

                selection.selectAll('.text-label')
                    .data(_data)
                    .enter().append('text')
                    .attr('class', 'text-label')
                    .attr('text-anchor', 'middle')
                    .attr('x', d => xScale(d.cumulative) + (xScale(d.value) / 2))
                    .attr('y', (h / 2) + (halfBarHeight * 1.1) + 20)
                    .style('fill', (d, i) => colors[i])
                    .text(d => d.label)
            }
            raceBar('#chart-1', raceData)

    // // //
    // STAT CHART
    // // // 

    function drawStatCharta(){
        var chartWidth = document.getElementById('chart-5').clientWidth;;

        const data = [
            { label: 'Percent parents who agree "my child feels safe at school"', value: {{ district.par_child_feels_safe }} },
        ]


        var margin = {
            top: 0,
            right: 0,
            bottom: 0,
            left: 0
        }
        var width = chartWidth - margin.left - margin.right
        var height = 200 - margin.top - margin.bottom;

        const div = d3.select("#chart-5")
            .append("div")
            .style("width", `${width}px`)
            .style("height", `${height}px`)
            .style("text-align","center")
            .style("margin", "auto")
            .selectAll(null)
            .data(data)
            .enter()


        const num = div

            .append("h1")
            .text(function (d) {
                return `${d.value}%`
            })
            .style("font-size","84px")
            .style("color","#82C566")
            .style("font-family","miller-headline")
            .style("font-weight","700")

        const text = div
            .append("h5")
            .text(function (d) {
                console.log(d)
                return d.label
            })
   
    }
    drawStatCharta()

    // // //
    // STAT CHART 2
    // // //


    function drawStatChartb(){
        var chartWidth = document.getElementById('chart-6').clientWidth;;

        const data = [
            { label: 'Average teacher pay', value: {{ district.admin_salary_curr_yr }}},
        ]

        var margin = {
            top: 0,
            right: 0,
            bottom: 0,
            left: 0
        }
        var width = chartWidth - margin.left - margin.right
        var height = 200 - margin.top - margin.bottom;

        const div = d3.select("#chart-6")
            .append("div")
            .style("width", `${width}px`)
            .style("height", `${height}px`)
            .style("text-align","center")
            .style("margin", "auto")
            .selectAll(null)
            .data(data)
            .enter()


        const num = div

            .append("h1")
            .text(function (d) {
                d.value = +d.value
                v = d.value.toLocaleString('en-US');
                return `$${v}`
            })
            .style("font-size","84px")
            .style("color","#82C566")
            .style("font-family","miller-headline")
            .style("font-weight","700")

        const text = div
            .append("h5")
            .text(function (d) {
                console.log(d)
                return d.label
            })
   
    }
    drawStatChartb()

    // // //
    // DOT CHART
    // // //

    var dotChartWidth = document.getElementById('chart-4').clientWidth;;

    var dotData = [{{ district.percent_male| int }}, {{ district.percent_female| int }}, {{ district.percent_gender_missing| int }}];
    // ORDER: Boys, girls, missing
    var list = []

    for (let step = 0; step < dotData[0]; step++) {
        list.push("boy")
    }

    for (let step = 0; step < dotData[1]; step++) {
        list.push("girl")
    }

    for (let step = 0; step < dotData[2]; step++) {
        list.push("missing")
    }

    var margin = {
        top: 10,
        right: 20,
        bottom: 10,
        left: 20
    }
    var width = dotChartWidth - margin.left - margin.right
    var height = 100 - margin.top - margin.bottom;

    var tooltip = d3.select("body")
        .append("div")
        .append("p")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("visibility", "hidden")
        .style("background", "#262B28")
        .style("padding-top", "5px")
        .style("padding-bottom", "5px")
        .style("padding-right", "5px")
        .style("padding-left", "5px")
        .style("border-radius", "5px")
        .style("color", "#F3F4F2")

    var div = d3.select("#chart-4")
        .append("div")
        .attr("class", "dot-holder")
        .style("width", `${dotChartWidth}px`)
        .style("height", `${height}px`)
        .selectAll("div")
        .data(list).enter()
        .append("div")
        .attr("class", function (d) {
            // console.log(d)
            return `dot ${d}`
        })
        .style("background-color", function (d) {
            if (d == "boy") {
                return "#F2734F"
            } else if (d == "girl") {
                return "#9264BA"
            } else if (d == "missing") {
                return "#82C566"
            }
            console.log(d)
        })
        .on("mouseover", function (d, i) {
            var name;
            if (i == "boy") {
                tooltip.text(`Boys: ${dotData[0]}%`)
            } else if (i == "girl") {
                tooltip.text(`Girls: ${dotData[1]}%`)
            } else if (i == "missing") {
                tooltip.text(`Missing: ${dotData[2]}%`)
            }

            return tooltip.style("visibility", "visible");
        })
        .on("mousemove", function (e) {
            // console.log(e)
            return tooltip
                .style("top", (e.pageY - 10) + "px")
                .style("left", (e.pageX + 10) + "px");

        })
        .on("mouseout", function () {
            return tooltip
                .style("visibility", "hidden");
        });

    // // //
    // PARALLEL LINES CHART
    // // //

    var povertyChartWidth = document.getElementById('chart-3').clientWidth;

    var data = [{{ '%0.2f'| format(district.studentsin_poverty_pct_curr_yr|float) }}, "98"];
    var dataLabels = ["School", "District"]
    var margin = {
        top: 20,
        right: 10,
        bottom: 20,
        left: 60
    }
    var width = povertyChartWidth - margin.left - margin.right
    var height = 100 - margin.top - margin.bottom;

    var y = d3.scaleBand()
        .range([height, 0])
        .padding(0.4);

    var x = d3.scaleLinear()
        .range([0, width])
        .domain([0, width]);


    var svg = d3.select("#chart-3").append("svg")
        .attr("width", povertyChartWidth)
        .attr("height", 120)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");


    var backgroundLines = svg.selectAll(null)
        // svg.selectAll("line")
        .data(data)
        .enter().append("line")
        .attr("class", "line")
        .attr("stroke", "lightgray")
        .attr("stroke-width", 5)
        .attr("stroke-linecap","round")
        .attr("x1", function (d) {
            return 0;
        })
        .attr("y1", function (d, i) {
            return i * 50
        })
        .attr("x2", function (d) {
            // console.log(width)
            return (width)
        })
        .attr("y2", function (d, i) {
            return i * 50
        })

    var tooltip = d3.select("body")
        .append("div")
        .append("p")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("visibility", "hidden")
        .style("background", "#262B28")
        .style("padding-top", "5px")
        .style("padding-bottom", "5px")
        .style("padding-right", "5px")
        .style("padding-left", "5px")
        .style("border-radius", "5px")
        .style("color", "#F3F4F2")

    var lines = svg.selectAll(null)
        .data(data)
        .enter().append("line")
        .attr("class", "line")
        .attr("stroke", "#F2734F")
        .attr("stroke-width", 5)
        .attr("stroke-linecap","round")
        .attr("x1", function (d) {
            return 0;
        })
        .attr("y1", function (d, i) {
            return i * 50
        })
        .attr("x2", function (d) {
            // console.log(width * (d / 100))
            return (width * (d / 100))
        })
        .attr("y2", function (d, i) {
            return i * 50
        })
        .on("mouseover", function (d, i) {
            tooltip.text(`${i}%`);
            return tooltip.style("visibility", "visible");
        })
        .on("mousemove", function (e) {
            // console.log(e)
            return tooltip
                .style("top", (e.pageY - 10) + "px")
                .style("left", (e.pageX + 10) + "px");

        })
        .on("mouseout", function () {
            return tooltip
                .style("visibility", "hidden");
        });

    var dot = svg.selectAll(null)
        .data(data)
        .enter().append('circle')
        .attr("class", "circle")
        .attr("cx", function (d) {
            return (width * (d / 100))
        })
        .attr("cy", function (d, i) {
            return i * 50;
        })
        .attr("r", "5")
        .attr("stroke-width", "3")
        .attr("fill", "#F2734F")

    var labels = svg.selectAll(null)
        .data(dataLabels)
        .enter()
        .append("text")
        .attr("y", function (d, i) {
            return (i * 50) + 5;
        })
        .attr("x", -10)
        .attr("text-anchor", "end")
        .text(function (d) {
            return d
        });


    var hundred = svg
        .append("text")
        .text("100%")
        .attr("y", function (d, i) {
            // console.log(y)
            return (50) + 40
        })
        .attr("x", function (d) {
            return width
        })
        .attr("text-anchor", "end")

    var zero = svg
        .append("text")
        .text("0")
        .attr("y", function (d, i) {
            // console.log(y)
            return (50) + 40
        })
        .attr("x", function (d) {
            return 0
        })
        .attr("text-anchor", "start")


</script>


</body>

</html>